{
    "URL": "https://github.com/verilator/verilator/issues/3885",
    "Summary": "Duplicate declaration of block: 'unnamedblk1'",
    "Description": "Verilator fails when there are begin end block with a variable declaration and a foreach in one scope.\nmodule Foo;\n   function void func();\n      int a[2];\n\n      begin\n         int t;\n      end\n\n      foreach (a[i]) begin\n      end\n   endfunction\nendmodule\nHere's output of verilator --lint-only ../bad.v --debug --debugi 5. I've marked with !!!! the place where \"unnamedblk1\" name assignment happens.\n- V3LinkDot.cpp:207:  LinkDotState: \n- V3LinkDot.cpp:1509: LinkDotFindVisitor: \n- V3LinkDot.cpp:911:  Module not under any CELL or top - dead module: MODULE 0x154004f20 {c1ai}  Foo  L0 [1ps]\n- V3LinkDot.cpp:870:       Link Module: MODULE 0x154004f20 {c1ai} u1=0x154004d80  Foo  L0 [1ps]\n- V3LinkDot.cpp:1057:    TASK 0x154005100 {c2as}  func\n- V3LinkDot.cpp:1023:    BEGIN 0x154005a80 {c5ah} [UNNAMED]\n!!!!\n- V3LinkDot.cpp:1023:    BEGIN 0x154006280 {c9aw} [UNNAMED]\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_004_prelinkdot-find.tree\n- V3LinkDot.cpp:1704: LinkDotParamVisitor: \n- V3LinkDot.cpp:1556:    MODULE 0x154004f20 {c1ai} u1=0x154004d80 u4=0x1  Foo  L0 [1ps]\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_005_prelinkdot-param.tree\n- V3LinkDot.cpp:3346: LinkDotResolveVisitor: \n- V3LinkDot.cpp:3098:    TASK 0x154005100 {c2as} u1=0x154004e20  func\n- V3LinkDot.cpp:3084:    BEGIN 0x154005a80 {c5ah} u1=0x1540065a0  unnamedblk1 [UNNAMED]\n- V3LinkDot.cpp:3090:    cur=se0x1540065a0\n- V3LinkDot.cpp:3095:    cur=se0x154004e20\n- V3LinkDot.cpp:3120:    FOREACH 0x1540063e0 {c9ah} u1=0x1540066e0\n- V3LinkDot.cpp:3084:    BEGIN 0x154006280 {c9aw} [UNNAMED]\n- V3LinkDot.cpp:3095:    cur=se0x1540066e0\n- V3LinkResolve.cpp:513:linkResolve: \n- V3LinkLValue.cpp:360:linkLValue: \n- V3LinkJump.cpp:322: linkJump: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_009_linkjump.tree\n- V3LinkInc.cpp:292:  linkIncrements: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_010_linkinc.tree\n- V3Param.cpp:1311:   param: \n- V3LinkDot.cpp:3397: linkDotParamed: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_012_prelinkdot.tree\n- V3LinkDot.cpp:207:  LinkDotState: \n- V3LinkDot.cpp:1509: LinkDotFindVisitor: \n- V3LinkDot.cpp:911:  Module not under any CELL or top - dead module: MODULE 0x154004f20 {c1ai}  Foo  L0 [1ps]\n- V3LinkDot.cpp:870:       Link Module: MODULE 0x154004f20 {c1ai} u1=0x1540072e0  Foo  L0 [1ps]\n- V3LinkDot.cpp:1057:    TASK 0x154005100 {c2as}  func\n- V3LinkDot.cpp:1023:    BEGIN 0x154005a80 {c5ah}  unnamedblk1 [UNNAMED]\n- V3LinkDot.cpp:1023:    BEGIN 0x154006280 {c9aw} [UNNAMED]\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_013_prelinkdot-find.tree\n- V3LinkDot.cpp:1704: LinkDotParamVisitor: \n- V3LinkDot.cpp:1556:    MODULE 0x154004f20 {c1ai} u1=0x1540072e0 u4=0x1  Foo  L0 [1ps]\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_014_prelinkdot-param.tree\n- V3LinkDot.cpp:3346: LinkDotResolveVisitor: \n- V3LinkDot.cpp:3098:    TASK 0x154005100 {c2as} u1=0x154007380  func\n- V3LinkDot.cpp:3084:    BEGIN 0x154005a80 {c5ah} u1=0x154007500  unnamedblk1 [UNNAMED]\n- V3LinkDot.cpp:3090:    cur=se0x154007500\n- V3LinkDot.cpp:3095:    cur=se0x154007380\n- V3LinkDot.cpp:3120:    FOREACH 0x1540063e0 {c9ah} u1=0x154007650\n- V3LinkDot.cpp:3084:    BEGIN 0x154006280 {c9aw} [UNNAMED]\n- V3LinkDot.cpp:3095:    cur=se0x154007650\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_015_linkdotparam.tree\n- V3Dead.cpp:538:     deadifyModules: \n- V3Width.cpp:7179:   width: \n- V3Width.cpp:1694:   dtWidthed BASICDTYPE 0x1540057f0 {c3ah} @dt=this@(sw32)  int kwd=int range=[31:0]\n- V3Width.cpp:7194:   widthParamsEdit: CONST 0x154006580 {c3an} @dt=0x154007e00@(G/w32)  32'h0\n- V3Width.cpp:7194:   widthParamsEdit: SUB 0x154004e40 {c3an} @dt=0x154005590@(G/swu32/2)\n- V3Const.cpp:1623:   BICONST -> 32'h1\n- V3Width.cpp:1596:   dtWidthed UNPACKARRAYDTYPE 0x1540064c0 {c3am} @dt=this@(sw32)u[0:1] refdt=0x1540057f0(sw32) [0:1]\n- V3Width.cpp:2131:   varWidthed VAR 0x154005960 {c3al} @dt=0x1540064c0@(sw32)u[0:1]  a [FUNC] [VAUTOM]  VAR\n- V3Width.cpp:1694:   dtWidthed BASICDTYPE 0x154005310 {c6ak} @dt=this@(sw32)  int kwd=int range=[31:0]\n- V3Width.cpp:2131:   varWidthed VAR 0x154005d20 {c6ao} @dt=0x154005310@(sw32)  t [FUNC] [VAUTOM]  VAR\n- V3Width.cpp:2131:   varWidthed VAR 0x154006780 {c9as} @dt=0x154006d20@(G/sw32)  i [LOOP] [FUNC] BLOCKTEMP\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_017_width.tree\n- V3Width.cpp:7222:   widthCommit: \n- V3Const.cpp:3753:   constifyAllLive: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_019_const.tree\n- V3Undriven.cpp:483: undrivenAll: \n- V3AssertPre.cpp:490:assertPreAll: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_020_assertpre.tree\n- V3Assert.cpp:526:   assertAll: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_021_assert.tree\n- V3LinkLevel.cpp:142:wrapTop: \n- V3LinkLevel.cpp:242:LOOP MODULE 0x154004f20 {c1ai}  Foo  L0 [1ps]\n- V3Const.cpp:3720:   constifyAllLint: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_023_const.tree\n- V3SplitVar.cpp:1246:splitVariable: \n- V3SplitVar.cpp:463: Start checking '$root'\n- V3SplitVar.cpp:463: Start checking 'Foo'\n- V3SplitVar.cpp:463: Start checking '@CONST-POOL@'\n- V3Inst.cpp:623:     dearrayAll: \n- V3Inst.cpp:238:       CELL   CELL 0x1540090e0 {c1ai}  Foo -> MODULE 0x154004f20 {c1ai}  Foo  L0 [1ps]\n- V3LinkDot.cpp:3403: linkDotArrayed: \n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_027_prelinkdot.tree\n- V3LinkDot.cpp:207:  LinkDotState: \n- V3LinkDot.cpp:1509: LinkDotFindVisitor: \n- V3LinkDot.cpp:911:  Module not under any CELL or top - dead module: MODULE 0x154004f20 {c1ai}  Foo  L0 [1ps]\n- V3LinkDot.cpp:911:  Module not under any CELL or top - dead module: MODULE 0x154008fe0 {c1ai}  __024root  L1 [P] [1ps]\n- V3LinkDot.cpp:870:       Link Module: MODULE 0x154008fe0 {c1ai} u1=0x154009820  __024root  L1 [P] [1ps]\n- V3LinkDot.cpp:964:     CELL under TOP is CELL 0x1540090e0 {c1ai}  Foo -> MODULE 0x154004f20 {c1ai}  Foo  L0 [1ps]\n- V3LinkDot.cpp:870:       Link Module: MODULE 0x154004f20 {c1ai} u1=0x1540098c0  Foo  L0 [1ps]\n- V3LinkDot.cpp:1057:    TASK 0x154005100 {c2as}  func\n- V3LinkDot.cpp:1023:    BEGIN 0x154005a80 {c5ah}  unnamedblk1 [UNNAMED]\n- V3LinkDot.cpp:1023:    BEGIN 0x154008a50 {c9ah} [UNNAMED] [IMPLIED]\n!!!!\n- V3LinkDot.cpp:271:  name unnamedblk1\n- V3LinkDot.cpp:272:  Var1 BEGIN 0x154008a50 {c9ah} u1=0x154009c40  unnamedblk1 [UNNAMED] [IMPLIED]\n- V3LinkDot.cpp:273:  Var2 BEGIN 0x154005a80 {c5ah} u1=0x154009b00  unnamedblk1 [UNNAMED]\n%Error: ../bad.v:9:7: Duplicate declaration of block: 'unnamedblk1'\n                    : ... In instance Foo\n    9 |       foreach (a[i]) begin\n      |       ^~~~~~~\n        ../bad.v:5:7: ... Location of original declaration\n    5 |       begin\n      |       ^~~~~\n-node: BEGIN 0x154008a50 {c9ah} u1=0x154009c40  unnamedblk1 [UNNAMED] [IMPLIED]\n- V3Ast.cpp:1122:     Dumping obj_dir/Vbad_029_linkdot-preerr.tree\n- V3LinkDot.cpp:1023:    BEGIN 0x154006280 {c9aw} [UNNAMED]\n- V3LinkDot.cpp:870:       Link Module: MODULE 0x154004f20 {c1ai} u1=0x15400a030 u4=0x1  Foo  L0 [1ps]\n- V3LinkDot.cpp:1057:    TASK 0x154005100 {c2as} u1=0x154009960  func\n- V3LinkDot.cpp:1023:    BEGIN 0x154005a80 {c5ah} u1=0x154009b00  unnamedblk1 [UNNAMED]\n- V3LinkDot.cpp:1023:    BEGIN 0x154008a50 {c9ah} u1=0x154009c40  unnamedblk1 [UNNAMED] [IMPLIED]\n- V3LinkDot.cpp:271:  name unnamedblk1\n- V3LinkDot.cpp:272:  Var1 BEGIN 0x154008a50 {c9ah} u1=0x15400a520  unnamedblk1 [UNNAMED] [IMPLIED]\n- V3LinkDot.cpp:273:  Var2 BEGIN 0x154005a80 {c5ah} u1=0x15400a310  unnamedblk1 [UNNAMED]\n%Error: ../bad.v:9:7: Duplicate declaration of block: 'unnamedblk1'\n                    : ... In instance Foo\n    9 |       foreach (a[i]) begin\n      |       ^~~~~~~\n        ../bad.v:5:7: ... Location of original declaration\n    5 |       begin\n      |       ^~~~~\n\nDo we have here two instances of a Visitor, and each instance starts to numerate blocks from 1?\n./bin/verilator_bin --version                              \nVerilator 5.005 devel rev v5.004-65-g3fe81a383 (mod)\n\nOS: macOS Ventura 13.1"
}