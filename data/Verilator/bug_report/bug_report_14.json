{
    "URL": "https://github.com/verilator/verilator/issues/4148",
    "Summary": "SIGSEGV after calling SystemVerilog task from C function",
    "Description": "Hi,\nThanks for maintaining Verilator, it helps us a lot!\nToday I got SIGSEGV when calling SystemVerilog task from C function through DPI-C, using Verilator v5.008(tag) that is built from source using g++ on Ubuntu 20.04.\nThe minimal code that reproduces the problem is as follows.\ntop.sv:\n`default_nettype none\n`timescale 1ns/1ps\n\nmodule TOP;\n\n    localparam cycle = 1000.0 / 100.0;\n    localparam halfcycle = 0.5 * cycle;\n\n    logic clk = '0;\n\n    import \"DPI-C\" context task tb_c_wait();\n\n    export \"DPI-C\" task tb_sv_wait;\n    task automatic tb_sv_wait(input int n);\n        $display(\"tb_sv_wait(\", n, \")\");\n        repeat(n) @(negedge clk); // if we comment this line out, it works.\n    endtask\n\n    initial begin\n        forever begin\n            #halfcycle clk = ~clk;\n        end\n    end\n\n    initial begin\n        $display(\"calling tb_c_wait...\");\n        repeat(10) @(posedge clk);\n        tb_c_wait();\n        repeat(10) @(posedge clk);\n        $finish();\n    end\n\nendmodule\n`default_nettype wire\ndpi.c:\n#include \"VTOP__Dpi.h\"\n#include <stdio.h>\n\nint tb_c_wait()\n{\n    printf(\"calling tb_sv_wait...\\n\");\n    fflush(stdout);\n    tb_sv_wait(10);\n    printf(\"done!\\n\");\n    fflush(stdout);\n    return 0;\n}\nAnd I compiled the code with the following Makefile:\n.DEFAULT_GOAL := all\n\nVERILATOR_MAKE_FLAGS = --compiler gcc -MAKEFLAGS \"CXX=g++-11 LINK=g++-11 VERILATOR_ROOT=/path/to/verilator5 -j4\"\nall: dpi.c top.sv Makefile\n        @verilator --version\n        verilator --binary -sv -Wno-BLKANDNBLK $(VERILATOR_MAKE_FLAGS) --top-module TOP top.sv dpi.c\nIt appears that the problem occurs when the internally-defined VTOP___024root____Vdpiexp_TOP__DOT__tb_sv_wait_TOP is called.\nSince the task does @(negedge clock), the function uses co_await and therefore returns VlCoroutine. But the alias type VTOP__Vcb_tb_sv_wait_t defined in VTOP__Syms.h returns void.\nI have written a simple patch to fix this problem and am now writing a PullReq.\nCould you take a look at it when you have a moment?\nThanks in advance."
}