{
    "URL": "https://github.com/verilator/verilator/issues/3544",
    "Summary": "Case with string literal generates uncompilable code",
    "Description": "On verilator 4.224 as well as master branch\nThe following code:\nmodule tjo();\n\nfunction automatic string broken_case(input string some_string);\n    case(some_string)\n        \"foo\": return \"foo\";\n        default: return \"bar\";\n    endcase\nendfunction\n\ninitial begin\n    $display(broken_case(\"baz\"));\nend\nendmodule\nGenerate code that will not compile. The error is:\nVtjo___024root__DepSet_h3395a8d1__0__Slow.cpp: In function ‘void Vtjo___024root___initial__TOP__0(Vtjo___024root*)’:\nVtjo___024root__DepSet_h3395a8d1__0__Slow.cpp:21:30: error: no match for ‘operator==’ (operand types are ‘long long unsigned int’ and ‘std::string’ {aka ‘std::__cxx11::basic_string<char>’})\n   21 |             if ((0x666f6fULL == __Vfunc_tjo__DOT__broken_case__0__some_string)) {\n      |                  ~~~~~~~~~~~ ^~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n      |                  |              |\n      |                  |              std::string {aka std::__cxx11::basic_string<char>}\n      |                  long long unsigned int\n\nThe generated code looks like this:\nVL_ATTR_COLD void Vtjo___024root___initial__TOP__0(Vtjo___024root* vlSelf) {\n    if (false && vlSelf) {}  // Prevent unused\n    Vtjo__Syms* const __restrict vlSymsp VL_ATTR_UNUSED = vlSelf->vlSymsp;\n    VL_DEBUG_IF(VL_DBG_MSGF(\"+    Vtjo___024root___initial__TOP__0\\n\"); );\n    // Init\n    std::string __Vfunc_tjo__DOT__broken_case__0__Vfuncout;\n    std::string __Vfunc_tjo__DOT__broken_case__0__some_string;\n    // Body\n    __Vfunc_tjo__DOT__broken_case__0__some_string = \n        std::string(\"baz\");\n    {\n        {\n            if ((0x666f6fULL == __Vfunc_tjo__DOT__broken_case__0__some_string)) {\n                __Vfunc_tjo__DOT__broken_case__0__Vfuncout = \n                    std::string(\"foo\");\n                goto __Vlabel2;\n            } else {\n                __Vfunc_tjo__DOT__broken_case__0__Vfuncout = \n                    std::string(\"bar\");\n                goto __Vlabel1;\n            }\n            __Vlabel2: ;\n        }\n        __Vlabel1: ;\n    }\n    VL_WRITEF(\"%@\\n\",-1,&(__Vfunc_tjo__DOT__broken_case__0__Vfuncout));\n}\nThe broken part\n            if ((0x666f6fULL == __Vfunc_tjo__DOT__broken_case__0__some_string)) {\nIt looks like string literals are incorrectly converted to unsigned long long instead of std::string. A verilog string is correctly converted to a std::string.\nI am not sure where in the code this conversion is done. With some pointers I can help create a fix for this, if it is not too complex."
}